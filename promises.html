<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AAP Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  {% set base = '.' %}
  {% include template-navbar.html %}
  <!-- TODO: Filter bars -->
  <div class="container-fluid">
    {% include banner.html %}
    <template>
      <div class="text-center h1 text-primary">Promises</div>
      <div class="row">
        <div class="col-md-2 sidebar my-2 pr-0">
          <div class="h4 text-primary">Outcomes</div>
          <div class="divider"></div>
          <ul class="nav flex-column nav-pills">
            <% outcomes.forEach(function(outcome){ %>
            <li class="nav-item">
              <a class="nav-link <%= outcome.Outcome==selOutcome?'active':''%>"
                href="promises?Outcome=<%=outcome.Outcome%>"><%= outcome.Outcome %></a></li>
            <% }) %>
          </ul>
        </div>
        <div class="col-md-10 px-0">
          <div class="col-md-12 ml-0">
            <% Object.keys(promises).forEach(function(promise){ %>
            <div class="card mb-2">
              <div class="card-body">
                <div class="card-title h4 text-primary text-shadow d-flex flex-row">

                  <div class="mr-1 text-center">
                    <span>
                      <button type="button" class="btn btn-success round">
                        <span
                          class="badge badge-light round"><%= promises[promise]['Done']!=null?promises[promise]['Done']:0%></span>
                      </button>
                    </span>
                    <span>
                      <button type="button" class="btn btn-warning round">
                        <span
                          class="badge badge-light round"><%= promises[promise]['In Progress']!=null?promises[promise]['In Progress']:0 %></span>
                      </button>
                    </span>
                    <span>
                      <button type="button" class="btn btn-primary round">
                        <span
                          class="badge badge-light round"><%= promises[promise]['Started']!=null?promises[promise]['Started']:0%></span>
                      </button>
                    </span>
                    <span>
                      <button type="button" class="btn btn-danger round">
                        <span
                          class="badge badge-light round"><%= promises[promise]['Not Started']!=null?promises[promise]['Not Started']:0%></span>
                      </button>
                    </span>
                  </div>


                  <a href="updates?Promise=<%= promise %>"> <span><%= promise.toUpperCase() %></span> </a>
                </div>
                <ul class="list-group list-group-flush">
                  <% promises[promise]['subPromises'].forEach(function(subPromise){ %>
                  <li class="list-group-item">

                    <a href="updates?SubPromise=<%= subPromise %>"> <span><%=subPromise%></span> </a>
                    <span>
                      <button type="button" class="btn btn-success round">
                        <span
                          class="badge badge-light round" ><%= subPromises[subPromise]['Done']!=null?subPromises[subPromise]['Done']:0%></span>

                      </button>
                    </span>
                    <span>
                      <button type="button" class="btn btn-warning round">
                        <span
                          class="badge badge-light round"><%= subPromises[subPromise]['In Progress']!=null?subPromises[subPromise]['In Progress']:0 %></span>
                      </button>
                    </span>
                    <span>
                      <button type="button" class="btn btn-primary round">
                        <span
                          class="badge badge-light round"><%= subPromises[subPromise]['Started']!=null?subPromises[subPromise]['Started']:0%></span>
                      </button>
                    </span>
                    <span>
                      <button type="button" class="btn btn-danger round">
                        <span
                          class="badge badge-light round"><%= subPromises[subPromise]['Not Started']!=null?subPromises[subPromise]['Not Started']:0%></span>
                      </button>
                    </span>
                  </li>
                  <% }) %>
                </ul>
              </div>
            </div>
            <% }) %>
          </div>
    </template>
  </div>
  </div> <!-- .container-fluid -->

  <script src="ui/jquery/dist/jquery.min.js"></script>
  <script src="ui/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="ui/lodash/lodash.min.js"></script>
  <script src="ui/g1/dist/g1.min.js"></script>
  <script>
    $(function () {
      url = g1.url.parse(window.location)
      let selOutcome = url.searchKey.Outcome || ''
      $.when(
        $.getJSON('data/outcomes?_sort=Outcome'),
        $.getJSON(`data/promises?Outcome=${selOutcome}`),
        $.getJSON('data/updates?_by=Promise&_by=Status&_c=Status|count'),
        $.getJSON('data/updates?_by=SubPromise&_by=Status&_c=Status|count')
        // $.get('data/updates')
      ).done(function (outcomes, promises, updateStatusByPromise, updateStatusBySubPromise) {
        var promiseCollector = {}
        var subPromiseCollector = {}

        promises[0].forEach(function (o) {
          if (o.Promise in promiseCollector)
            promiseCollector[o.Promise]['subPromises'].push(o['Sub promise'])
          else {
            promiseCollector[o.Promise] = { 'subPromises': [o['Sub promise']] }
          }
        })

        updateStatusByPromise[0].forEach(function (statusCount) {
          promiseCollector[statusCount.Promise][statusCount.Status] = statusCount['Status|count']
        })

        promises[0].forEach(function (subPromiseAdd) {
          subPromiseCollector[subPromiseAdd['Sub promise']] = {}
        })

        updateStatusBySubPromise[0].forEach(function (statusCount) {

          if (statusCount.SubPromise in subPromiseCollector)
            subPromiseCollector[statusCount.SubPromise][statusCount.Status] = statusCount['Status|count']
        })




        console.log(subPromiseCollector)
        $('body').template({
          outcomes: outcomes[0],
          promises: promiseCollector,
          selOutcome: selOutcome,
          subPromises: subPromiseCollector
        })
      })

    })
  </script>
  <!-- Commonly used libraries:
  <script src="ui/d3v5/dist/d3.min.js"></script>
  <script src="ui/morphdom/dist/morphdom-umd.min.js"></script>
  <script src="ui/moment/min/moment-with-locales.min.js"></script>
  <script src="ui/daterangepicker/daterangepicker.js"></script>
  <script src="ui/leaflet/dist/leaflet.js"></script>
  <script src="ui/topojson/dist/topojson.min.js"></script>
  -->
</body>

</html>