<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AAP Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  {% set base = '.' %}
  {% include template-navbar.html %}
  <!-- TODO: Filter bars -->
  <div class="container-fluid px-0">
    {%include banner.html %}
    <div class="d-flex flex-row">
      <div class="sidebar col-md-4 d-flex flex-column">
        <div class="h2  text-primary mt-2 mx-auto">Updates</div>
        <div id="donutChart" class="mx-auto"></div>
        <div class="h2 text-primary mt-2 mx-auto">Top Departments</div>
        <div id="departmentChart" class="mx-auto"></div>
        <div class="h2 text-primary mt-2 mx-auto">Top Outcomes</div>
        <div id="outcomeChart" class="mx-auto"></div>
      </div> <!-- sidebar-->
      <div class="main_content">
        <div class="nav nav-row pt-2 pb-1 mb-0 nav_buttons">
          <div class="col-md-4 text-center mx-auto"> <a class="btn btn-primary btn-block h1 text-white"
              data-target="Outcome">Explore by Outcome</a> </div>
          <div class="col-md-4 text-center mx-auto"><a class="btn btn-primary btn-block h1 text-white"
              data-target="Department">Explore by Department</a></div>
        </div>
        <!--nav-buttons-->
        <div class="d-flex flex-wrap justify-content-around">
          <template>
            <% outcomes.forEach(function(outcome){ %>
            <div class="card col-md-4 px-0">
              <img class="card-img-top img-fluid image-ka-size-hai-ye" src="<%= outcome.img %>">
              <div class="card-body">
                <h5 class="card-title"><%= outcome.Outcome? outcome.Outcome : outcome.Department %></h5>
                <a href="promises?Outcome=<%= outcome.Outcome %>">
                  <p class="card-text">
                    <%= outcome['Promise|count']%> Promises</p>
                </a>
                <a href="updates?Outcome=<%= outcome.Outcome %>">
                  <p class="card-text">
                    <%= outcome['Update|count']  %> Updates</p>
                </a>
              </div>
            </div>
            <% }) %>
          </template>
        </div>
      </div>
      <!--main-content-->
    </div>
    <!--row-fluid-->



  </div> <!-- .container-fluid -->

  <script src="ui/jquery/dist/jquery.min.js"></script>
  <script src="ui/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script src="ui/lodash/lodash.min.js"></script>
  <script src="ui/g1/dist/g1.min.js"></script>
  <script src="ui/vega/build/vega.min.js"></script>
  <script src="js/donut.js"></script>
  <script src="js/marimeko.js"></script>
  <script>
    function getDataM() {
      $.when(
        $.getJSON('data/updates?_by=Department&_c=Department|count&_sort=-Department|count&_limit=5'),
        $.getJSON('data/updates?_by=Department&_by=Status&_c=Status|count')
      ).done(function (departments, updates) {
        var departments = departments[0].map(d => d.Department)
        filteredUpdates = updates[0].filter(u => departments.includes(u.Department))
        renderVega(marimekkoSpec, '#departmentChart', filteredUpdates)
      })
    }
    function renderVega(spec, field, data = null) {
      if (data) { // for the marimekko chart, data needs to be passed explicitly.
        spec.data[0].values = data
      }
      var view = new vega.View(vega.parse(spec))
        .renderer('svg')
        .logLevel(vega.Warn)
        .initialize(field)
        .hover()
        .run()
    }
    function draw_cards(field) {
      // Look up the appropriate set of urls and render the template
      let url = [`data/${field.toLowerCase()}?_sort=${field}`,
      `data/promises?_by=${field}&_c=${field}|count`,
      `data/updates?_by=${field}&_c=${field}|count`]
      $.when(
        $.getJSON(url[0]),
        $.getJSON(url[1]),
        $.getJSON(url[2])
      ).done(function (group, promises, updates) {
        promises = _.each(promises[0], function (obj) { obj['Promise|count'] = obj[`${field}|count`] })
        updates = _.each(updates[0], function (obj) { obj['Update|count'] = obj[`${field}|count`] })
        group = group[0]
        outputs = _.merge(group, promises, updates)
        // console.log(outputs)
        $('body').template({ outcomes: outputs })
      })
    }

    $(function () {
      getDataM()
      renderVega(donutSpec, '#donutChart')
      draw_cards('Outcome')
      $('.nav_buttons').on('click', function (button) {
        draw_cards($(button.target).data('target'))
      })
      getDataM()
    })
  </script>
  <!-- Commonly used libraries:
  <script src="ui/d3v5/dist/d3.min.js"></script>
  <script src="ui/morphdom/dist/morphdom-umd.min.js"></script>
  <script src="ui/moment/min/moment-with-locales.min.js"></script>
  <script src="ui/daterangepicker/daterangepicker.js"></script>
  <script src="ui/leaflet/dist/leaflet.js"></script>
  <script src="ui/topojson/dist/topojson.min.js"></script>
  -->
</body>

</html>
